<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cheers Campus Radio - Live Stream</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        .stream-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #player {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            display: block;
        }
        
        /* BRB Image - Show when no stream */
        #brbImage {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            display: none;
        }
        
        /* Minimal branding */
        .branding {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(30, 58, 138, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            color: #fbbf24;
            font-weight: bold;
            font-size: 18px;
            z-index: 100;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        
        .branding.fade-out {
            opacity: 0;
        }
        
        /* Status indicator */
        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 100;
            font-size: 14px;
            min-width: 120px;
        }
        
        .status.live {
            color: #4CAF50;
        }
        
        .status.offline {
            color: #f44336;
        }
        
        .status.waiting {
            color: #ff9800;
        }
        
        /* Hide default video controls except volume and fullscreen */
        #player::-webkit-media-controls-play-button,
        #player::-webkit-media-controls-pause-button,
        #player::-webkit-media-controls-start-playback-button,
        #player::-webkit-media-controls-timeline,
        #player::-webkit-media-controls-current-time-display,
        #player::-webkit-media-controls-time-remaining-display,
        #player::-webkit-media-controls-seek-back-button,
        #player::-webkit-media-controls-seek-forward-button {
            display: none !important;
        }

        /* Keep volume and fullscreen controls */
        #player::-webkit-media-controls-volume-slider,
        #player::-webkit-media-controls-fullscreen-button {
            display: block !important;
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            .branding {
                top: 10px;
                left: 10px;
                padding: 8px 12px;
                font-size: 16px;
            }
            
            .status {
                bottom: 10px;
                left: 10px;
                padding: 8px 12px;
                font-size: 12px;
                min-width: 100px;
            }
            
            #player {
                width: 100vw;
                height: 100vh;
                object-fit: cover; /* Better mobile viewing */
            }
            
            #brbImage {
                object-fit: cover; /* Better mobile viewing */
            }
        }
        
        /* iOS Safari specific fixes */
        #player {
            -webkit-playsinline: true;
            webkit-playsinline: true;
        }
        
        /* Loading overlay - hidden */
        .loading-overlay {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="stream-container">
        <!-- Minimal branding -->
        <div class="branding" id="branding">
            üéµ Cheers Campus Radio
        </div>
        
        <!-- BRB Image - shown when no stream -->
        <img id="brbImage" alt="Be Right Back - Cheers Campus Radio">
        
        <!-- Status -->
        <div class="status waiting" id="status">Standby</div>
        
        <!-- Video player -->
        <video 
            id="player" 
            autoplay
            playsinline
            webkit-playsinline
            controls
            disablePictureInPicture
            controlsList="nodownload noremoteplayback noplaybackrate"
            crossorigin="anonymous"
        ></video>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        // DOM Elements
        const video = document.getElementById("player");
        const branding = document.getElementById("branding");
        const status = document.getElementById("status");
        const brbImage = document.getElementById("brbImage");
        
        // Variables
        let hls = null;
        let isInitializing = false;
        let retryCount = 0;
        let retryTimer = null;
        let healthCheckInterval = null;
        let segmentCount = 0;
        let lastSegmentTime = 0;
        let connectionStartTime = 0;
        let isStreamActive = false;
        const MAX_RETRIES = 20;
        const RETRY_DELAY = 3000;
        const HEALTH_CHECK_INTERVAL = 5000;
        const STALE_THRESHOLD = 30000;
        
        // FIXED: Auto-detect server for network access
        const currentHost = window.location.hostname;
        const isLocalhost = currentHost === 'localhost' || currentHost === '127.0.0.1';
        
        // FIXED: Correct URL construction based on access method
        let hlsUrl, brbImageUrl;
        if (isLocalhost) {
            // Localhost access needs /campus-radio/ prefix
            hlsUrl = window.location.protocol + "//" + currentHost + "/campus-radio/public/hls/stream.m3u8";
            brbImageUrl = window.location.protocol + "//" + currentHost + "/campus-radio/assets/brb.jpg";
        } else {
            // Network IP access - virtual host already points to campus-radio folder
            hlsUrl = window.location.protocol + "//" + currentHost + "/public/hls/stream.m3u8";
            brbImageUrl = window.location.protocol + "//" + currentHost + "/assets/brb.jpg";
        }
        
        console.log('üéµ Connecting to:', hlsUrl);
        console.log('üì∑ BRB Image:', brbImageUrl);
        console.log('üåê Host detected:', currentHost, isLocalhost ? '(localhost)' : '(network)');
        
        // Set BRB image source
        brbImage.src = brbImageUrl;
        brbImage.onerror = () => {
            console.warn('BRB image not found, trying alternative paths...');
            // Try alternative paths
            const altPaths = [
                window.location.protocol + "//" + currentHost + "/campus-radio/assets/BRB.jpg",
                window.location.protocol + "//" + currentHost + "/campus-radio/assets/brb.png",
                window.location.protocol + "//" + currentHost + "/campus-radio/assets/BRB.png"
            ];
            
            let pathIndex = 0;
            const tryNextPath = () => {
                if (pathIndex < altPaths.length) {
                    console.log('Trying BRB path:', altPaths[pathIndex]);
                    brbImage.src = altPaths[pathIndex];
                    brbImage.onerror = () => {
                        pathIndex++;
                        tryNextPath();
                    };
                } else {
                    console.warn('No BRB image found in any location');
                    // Create a simple text-based BRB
                    createTextBRB();
                }
            };
            tryNextPath();
        };
        
        brbImage.onload = () => {
            console.log('‚úÖ BRB image loaded successfully');
        };
        
        // Create text-based BRB if image not found
        function createTextBRB() {
            const canvas = document.createElement('canvas');
            canvas.width = 1280;
            canvas.height = 720;
            const ctx = canvas.getContext('2d');
            
            // Background
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#1a1a2e');
            gradient.addColorStop(0.5, '#16213e');
            gradient.addColorStop(1, '#0f3460');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Main text
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 96px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üéµ Cheers Campus Radio', canvas.width/2, canvas.height/2 - 50);
            
            // Sub text
            ctx.fillStyle = '#ffb724';
            ctx.font = '48px Arial';
            ctx.fillText('Be Right Back', canvas.width/2, canvas.height/2 + 50);
            
            // Status
            ctx.fillStyle = '#888';
            ctx.font = '32px Arial';
            ctx.fillText('We\'ll be back with more great content soon!', canvas.width/2, canvas.height/2 + 120);
            
            // Convert to blob and use as image source
            canvas.toBlob((blob) => {
                brbImage.src = URL.createObjectURL(blob);
            });
        }
        
        // Hide branding after 3 seconds
        setTimeout(() => {
            branding.classList.add('fade-out');
        }, 3000);
        
        // FIXED: Enhanced mobile-friendly status messages
        function updateStatus(text, className = '') {
            // Mobile-friendly status messages
            if (text.includes('Network') && /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                if (text.includes('offline')) {
                    text = "Check WiFi connection";
                } else if (text.includes('restored')) {
                    text = "WiFi reconnected";
                }
            }
            
            status.textContent = text;
            status.className = 'status ' + className;
        }
        
        function showBRB() {
            console.log('üì∑ Showing BRB image - no active stream');
            video.style.display = 'none';
            brbImage.style.display = 'block';
            updateStatus("Standby", "waiting");
            isStreamActive = false;
        }
        
        function hideBRB() {
            console.log('üéµ Hiding BRB image - stream active');
            brbImage.style.display = 'none';
            video.style.display = 'block';
            isStreamActive = true;
        }
        
        function cleanupHLS() {
            if (hls) {
                hls.destroy();
                hls = null;
            }
            if (retryTimer) {
                clearTimeout(retryTimer);
                retryTimer = null;
            }
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
                healthCheckInterval = null;
            }
            video.src = '';
            segmentCount = 0;
            lastSegmentTime = 0;
            connectionStartTime = 0;
        }
        
        // FIXED: Better stream detection
        async function checkStreamAvailability() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                
                const response = await fetch(hlsUrl, { 
                    method: 'HEAD',
                    cache: 'no-cache',
                    signal: controller.signal,
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    return false;
                }
                
                // Additional check: try to fetch the playlist content
                const contentResponse = await fetch(hlsUrl, { 
                    method: 'GET',
                    cache: 'no-cache',
                    signal: controller.signal
                });
                
                if (contentResponse.ok) {
                    const content = await contentResponse.text();
                    // Check if playlist has actual segments
                    const hasSegments = content.includes('.ts') || content.includes('EXTINF');
                    console.log('Stream availability check:', hasSegments ? 'Active stream detected' : 'Empty playlist');
                    return hasSegments;
                }
                
                return false;
            } catch (error) {
                console.log('Stream check failed (normal if no stream):', error.message);
                return false;
            }
        }
        
        // FIXED: Better stream server status check for network access
        async function checkStreamServerStatus() {
            try {
                // Use detected host instead of hardcoded localhost
                const statusUrl = window.location.protocol + "//" + currentHost + ":9998/stream/status";
                const response = await fetch(statusUrl, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    return { active: false, connected: false };
                }
                
                const status = await response.json();
                console.log('Stream server status:', status);
                return status;
            } catch (error) {
                console.log('Stream server check failed (normal if server not running)');
                return { active: false, connected: false };
            }
        }
        
        function performHealthCheck() {
            if (!hls || !video) return;
            
            const now = Date.now();
            const timeSinceLastSegment = now - lastSegmentTime;
            
            // Check if stream has gone stale
            if (lastSegmentTime > 0 && timeSinceLastSegment > STALE_THRESHOLD) {
                console.warn(`Stream appears stale (${timeSinceLastSegment}ms since last segment)`);
                updateStatus("Stream reconnecting...", "waiting");
                showBRB();
                initializeStream();
                return;
            }
        }
        
        async function forcePlayWithAudio() {
            try {
                // Try unmuted first
                video.muted = false;
                await video.play();
                console.log("‚úÖ Auto-playing with audio");
                updateStatus("Live", "live");
                hideBRB();
                return true;
            } catch (error) {
                try {
                    // Fallback to muted
                    video.muted = true;
                    await video.play();
                    console.log("‚ö†Ô∏è Auto-playing muted (browser restriction)");
                    updateStatus("Live", "live");
                    hideBRB();
                    
                    // Try to unmute after a short delay
                    setTimeout(() => {
                        video.muted = false;
                        updateStatus("Live", "live");
                    }, 1000);
                    
                    return true;
                } catch (mutedError) {
                    console.error("‚ùå All playback attempts failed:", mutedError);
                    updateStatus("Click to play", "live");
                    return false;
                }
            }
        }
        
        async function initializeStream() {
            if (isInitializing) return;
            isInitializing = true;
            
            cleanupHLS();
            
            // FIXED: Check both stream availability and server status
            const isAvailable = await checkStreamAvailability();
            const serverStatus = await checkStreamServerStatus();
            
            if (!isAvailable || !serverStatus.active) {
                isInitializing = false;
                
                // Show BRB image when no stream is available
                showBRB();
                
                if (retryCount < MAX_RETRIES) {
                    retryTimer = setTimeout(() => {
                        retryCount++;
                        initializeStream();
                    }, RETRY_DELAY);
                } else {
                    // Reset retry count after max attempts
                    setTimeout(() => {
                        retryCount = 0;
                        initializeStream();
                    }, 10000);
                }
                return;
            }
            
            // Stream is available, hide BRB and start HLS
            console.log('üéµ Stream detected, starting HLS player...');
            
            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    lowLatencyMode: true,
                    backBufferLength: 0,
                    maxBufferLength: 6,
                    maxMaxBufferLength: 12,
                    maxBufferSize: 15 * 1000 * 1000,
                    manifestLoadingTimeOut: 6000,
                    manifestLoadingMaxRetry: 5,
                    manifestLoadingRetryDelay: 500,
                    levelLoadingTimeOut: 6000,
                    levelLoadingMaxRetry: 5,
                    fragLoadingTimeOut: 10000,
                    fragLoadingMaxRetry: 5,
                    startFragPrefetch: true,
                    progressive: true,
                    liveSyncDurationCount: 1,
                    liveMaxLatencyDurationCount: 3,
                    liveDurationInfinity: true,
                    capLevelToPlayerSize: true,
                    maxLoadingDelay: 4
                });
                
                const timestampedUrl = hlsUrl + '?t=' + Date.now();
                hls.loadSource(timestampedUrl);
                hls.attachMedia(video);
                connectionStartTime = Date.now();
                
                hls.on(Hls.Events.MANIFEST_PARSED, async () => {
                    isInitializing = false;
                    retryCount = 0;
                    
                    // Start health monitoring
                    if (healthCheckInterval) {
                        clearInterval(healthCheckInterval);
                    }
                    healthCheckInterval = setInterval(performHealthCheck, HEALTH_CHECK_INTERVAL);
                    
                    // Auto-start playback immediately
                    await forcePlayWithAudio();
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS Error:', data.type, data.details);
                    
                    if (data.fatal) {
                        isInitializing = false;
                        showBRB();
                        
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                updateStatus("Network error", "waiting");
                                setTimeout(() => initializeStream(), 2000);
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                updateStatus("Media error", "waiting");
                                try {
                                    hls.recoverMediaError();
                                } catch (e) {
                                    setTimeout(() => initializeStream(), 2000);
                                }
                                break;
                            default:
                                updateStatus("Stream error", "waiting");
                                setTimeout(() => initializeStream(), 2000);
                                break;
                        }
                    }
                });
                
                hls.on(Hls.Events.FRAG_LOADED, () => {
                    segmentCount++;
                    lastSegmentTime = Date.now();
                    if (retryCount > 0) {
                        retryCount = 0;
                    }
                    
                    // Ensure BRB is hidden when segments are loading
                    if (!isStreamActive) {
                        hideBRB();
                    }
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Safari native HLS
                video.src = hlsUrl + '?t=' + Date.now();
                connectionStartTime = Date.now();
                
                video.addEventListener('loadedmetadata', async () => {
                    isInitializing = false;
                    
                    // Start health monitoring
                    if (healthCheckInterval) {
                        clearInterval(healthCheckInterval);
                    }
                    healthCheckInterval = setInterval(performHealthCheck, HEALTH_CHECK_INTERVAL);
                    
                    await forcePlayWithAudio();
                });
                
                video.addEventListener('error', () => {
                    isInitializing = false;
                    updateStatus("Stream error", "waiting");
                    showBRB();
                    setTimeout(() => initializeStream(), 2000);
                });
            }
        }
        
        // Video event listeners
        video.addEventListener('playing', () => {
            updateStatus("Live", "live");
            hideBRB();
        });
        
        video.addEventListener('waiting', () => {
            updateStatus("Buffering...", "waiting");
        });
        
        video.addEventListener('stalled', () => {
            updateStatus("Stream buffering...", "waiting");
        });
        
        video.addEventListener('pause', () => {
            if (isStreamActive) {
                updateStatus("Paused", "waiting");
            }
        });
        
        video.addEventListener('error', (e) => {
            console.error("Video element error:", e);
            if (!isInitializing) {
                updateStatus("Video error", "offline");
                showBRB();
                setTimeout(() => initializeStream(), 2000);
            }
        });
        
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log("Page hidden - pausing health checks");
                if (retryTimer) {
                    clearTimeout(retryTimer);
                }
                if (healthCheckInterval) {
                    clearInterval(healthCheckInterval);
                    healthCheckInterval = null;
                }
            } else {
                console.log("Page visible - resuming");
                if (!hls && !isInitializing) {
                    initializeStream();
                } else if (hls && !healthCheckInterval) {
                    healthCheckInterval = setInterval(performHealthCheck, HEALTH_CHECK_INTERVAL);
                }
            }
        });
        
        // Network state handlers
        window.addEventListener('online', () => {
            console.log("Network back online");
            if (!hls && !isInitializing) {
                updateStatus("Network restored", "waiting");
                initializeStream();
            }
        });

        window.addEventListener('offline', () => {
            console.log("Network went offline");
            updateStatus("Network offline", "offline");
            showBRB();
            cleanupHLS();
        });
        
        // Disable right-click
        video.addEventListener('contextmenu', e => e.preventDefault());
        brbImage.addEventListener('contextmenu', e => e.preventDefault());
        
        // Start with BRB image and begin checking for stream
        showBRB();
        
        // Auto-detect if we're on mobile for better user experience
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // Start the stream check immediately, with faster retry on mobile
        setTimeout(() => {
            initializeStream();
        }, isMobile ? 500 : 1000);
        
        // Continuous monitoring - check every 5 seconds for stream availability
        setInterval(async () => {
            if (!hls && !isInitializing) {
                const isAvailable = await checkStreamAvailability();
                if (isAvailable && !isStreamActive) {
                    console.log('üéµ Stream became available, starting player...');
                    initializeStream();
                }
            }
        }, 5000);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            cleanupHLS();
        });
        
        // FIXED: Network connectivity debugging
        async function debugNetworkConnectivity() {
            console.log('=== Network Connectivity Debug ===');
            console.log('Current URL:', window.location.href);
            console.log('Detected host:', currentHost);
            console.log('HLS URL:', hlsUrl);
            
            // Test basic connectivity
            try {
                const testResponse = await fetch(window.location.protocol + "//" + currentHost + "/campus-radio/", {
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                console.log('‚úÖ Base server accessible:', testResponse.status);
            } catch (error) {
                console.error('‚ùå Base server not accessible:', error.message);
            }
            
            // Test stream server
            try {
                const streamResponse = await fetch(window.location.protocol + "//" + currentHost + ":9998/health", {
                    method: 'GET',
                    cache: 'no-cache'
                });
                console.log('‚úÖ Stream server accessible:', streamResponse.status);
            } catch (error) {
                console.error('‚ùå Stream server not accessible:', error.message);
            }
            
            console.log('=================================');
        }
        
        // Run network debug on load
        debugNetworkConnectivity();
        
        console.log("Enhanced HLS viewer initialized with BRB support and network connectivity");
    </script>
</body>
</html>