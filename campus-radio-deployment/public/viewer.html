<!-- public/viewer.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Campus Radio Live Stream</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #121212;
            color: white;
            font-family: sans-serif;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            text-align: center;
        }
        #player {
            width: 100%;
            border-radius: 8px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            margin-bottom: 10px;
        }

        /* Hide all controls except volume and fullscreen */
        #player::-webkit-media-controls-play-button,
        #player::-webkit-media-controls-pause-button,
        #player::-webkit-media-controls-start-playback-button,
        #player::-webkit-media-controls-timeline,
        #player::-webkit-media-controls-current-time-display,
        #player::-webkit-media-controls-time-remaining-display,
        #player::-webkit-media-controls-seek-back-button,
        #player::-webkit-media-controls-seek-forward-button {
            display: none !important;
            pointer-events: none !important;
        }

        /* Force volume slider and fullscreen button to show */
        #player::-webkit-media-controls-volume-slider,
        #player::-webkit-media-controls-fullscreen-button {
            display: block !important;
            pointer-events: auto !important;
        }

        /* Allow clicks on the native controls container */
        #player::-webkit-media-controls-enclosure,
        #player::-webkit-media-controls-panel,
        #player::-webkit-media-controls-overlay-enclosure {
            pointer-events: auto !important;
        }

        /* Mobile fullscreen button */
        .mobile-fullscreen {
            display: none;
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .mobile-fullscreen {
                display: block;
            }
        }

        .container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status">Connecting to stream...</div>
        <video 
            id="player" 
            playsinline 
            disablePictureInPicture
            controlsList="nodownload noremoteplayback noplaybackrate"
        ></video>
        <button class="mobile-fullscreen" onclick="toggleFullscreen()">â›¶</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const video = document.getElementById("player");
        const status = document.querySelector(".status");
        const hlsUrl = window.location.protocol + "//" + window.location.hostname + ":8080/hls/stream.m3u8";
        let hls = null;
        let isInitializing = false;

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                video.requestFullscreen().catch(err => {
                    console.log('Error attempting to enable fullscreen:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        async function autoPlayStream() {
            try {
                // First attempt: Try unmuted autoplay
                video.muted = false;
                await video.play();
                status.textContent = "Stream playing";
                console.log("Autoplay successful (unmuted)");
                return;
            } catch (error) {
                console.log("Unmuted autoplay failed, trying muted...");
            }
            
            try {
                // Second attempt: Try muted autoplay
                video.muted = true;
                await video.play();
                status.textContent = "Stream playing";
                
                // Try to unmute after a short delay
                setTimeout(async () => {
                    try {
                        video.muted = false;
                        console.log("Successfully unmuted after autoplay");
                        status.textContent = "Stream playing";
                    } catch (unmuteError) {
                        console.log("Could not unmute automatically");
                        // Stream will continue playing muted
                    }
                }, 1000);
                
                console.log("Autoplay successful (muted)");
                return;
            } catch (error) {
                console.log("All autoplay attempts failed");
                status.textContent = "Click to play stream";
                
                // Add a single click listener as final fallback
                const playOnClick = async () => {
                    try {
                        video.muted = false;
                        await video.play();
                        status.textContent = "Stream playing";
                        video.removeEventListener('click', playOnClick);
                    } catch (clickError) {
                        video.muted = true;
                        video.play();
                        status.textContent = "Stream playing (muted)";
                        video.removeEventListener('click', playOnClick);
                    }
                };
                
                video.addEventListener('click', playOnClick);
            }
        }

        // Also try autoplay on user interaction with the page
        document.addEventListener('click', function attemptDelayedAutoplay() {
            if (video.paused && hls) {
                autoPlayStream();
                document.removeEventListener('click', attemptDelayedAutoplay);
            }
        }, { once: true });

        function initializeStream() {
            if (isInitializing) return;
            isInitializing = true;

            if (hls) {
                hls.destroy();
                hls = null;
            }

            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: false, // Changed to false for better buffering
                    backBufferLength: 60,  // Increased buffer
                    maxBufferLength: 60,   // Increased buffer
                    maxMaxBufferLength: 90, // Increased buffer
                    maxBufferSize: 120 * 1000 * 1000, // 120MB buffer
                    maxBufferHole: 2.0,    // Increased tolerance
                    highBufferWatchdogPeriod: 5,
                    nudgeMaxRetry: 10,
                    nudgeOffset: 0.5,
                    manifestLoadingTimeOut: 15000,
                    manifestLoadingMaxRetry: 3,
                    levelLoadingTimeOut: 15000,
                    levelLoadingMaxRetry: 5,
                    fragLoadingTimeOut: 30000,
                    fragLoadingMaxRetry: 5,
                    startFragPrefetch: true,
                    testBandwidth: true,
                    progressive: true,
                    liveSyncDurationCount: 5,     // Increased for more buffering
                    liveMaxLatencyDurationCount: 15, // Allow more latency
                    maxLiveSyncPlaybackRate: 1.0  // Prevent speed adjustments
                });

                hls.loadSource(hlsUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    isInitializing = false;
                    status.textContent = "Stream ready";
                    
                    // Try to autoplay with multiple fallback strategies
                    autoPlayStream();
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        isInitializing = false;
                        status.textContent = "Stream not available - retrying...";
                        
                        setTimeout(() => {
                            initializeStream();
                        }, 5000);
                    }
                });
            }
        }

        // Disable right-click on video
        video.addEventListener('contextmenu', e => e.preventDefault());

        // Start streaming
        initializeStream();
    </script>
</body>
</html>
